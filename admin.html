<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="Estilos/stylesB.css">
  <title>Panel Admin</title>
</head>
<body class="bodyAdmins">
  <section class="opAdmins">
  <img src="Imagenes/settings.png" class="engranaje">
  <div class="soliRegistro">
  <h1>Solicitudes de Registro</h1>
  <ul id="regs"></ul>
  </div>

  <div class="comPago">
  <h1>Comprobantes de Pago</h1>
  <ul id="pays"></ul>
  </div>

  <div class="solicitudesUnidades">
    <h1>Solicitudes de Unidades</h1>
    <ul id="solicitudesUnidades"></ul>
  </div>

  <div class="resetearUsers">
  <button id="btnResetAll" style="margin-bottom:1em">
  Resetear todos los Usuarios (Horas & Plata)
  </button>
  </div>
  </section>

  <a href="admin_news.php">Noticias</a>

  <script>
    const api = "adminControlador.php";

    // Helper para POST
    function doPost(action, payload, cb) {
      fetch(api, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ action, ...payload })
      })
      .then(r => r.json())
      .then(json => {
        if (json.success) cb();
        else alert(json.error);
      })
      .catch(e => alert("Error de comunicación"));
    }

    // Cargar registros pendientes
    function loadRegs() {
      fetch(api+"?action=list_registros")
        .then(r => r.json())
        .then(list => {
          const ul = document.getElementById("regs");
          ul.innerHTML = "";
          list.forEach(u => {
            const li = document.createElement("li");
            li.innerHTML = `
              ${u.nombre} (CI: ${u.CI}, Cuota: ${u.cuota})
              <button onclick="doPost('aprobar_usuario',{id:${u.id}}, loadAllAdminViews)">
                Aprobar
              </button>
            `;
            ul.appendChild(li);
          });
        });
    }

    // Cargar pagos pendientes
    function loadPays() {
      fetch(api+"?action=list_pagos")
        .then(r => r.json())
        .then(list => {
          const ul = document.getElementById("pays");
          ul.innerHTML = "";
          list.forEach(p => {
            const li = document.createElement("li");
            li.innerHTML = `
              ${p.nombre} — $${p.monto}
              <br><img src="${p.recibo}" style="max-width:200px">
              <br>
              <button onclick="doPost('aprobar_pago',{pago_id:${p.pago_id}}, loadAllAdminViews)">
                Aprobar pago
              </button>
              <button onclick="doPost('rechazar_pago',{pago_id:${p.pago_id}}, loadAllAdminViews)">
                Rechazar pago
              </button>
            `;
            ul.appendChild(li);
          });
        });
    }

    // Cargar solicitudes de unidades pendientes
    function loadSolicitudesUnidades() {
      fetch(api + "?action=list_solicitudes_unidades")
        .then(r => r.json())
        .then(list => {
          const ul = document.getElementById("solicitudesUnidades");
          ul.innerHTML = "";
          if (!Array.isArray(list) || list.length === 0) {
            ul.innerHTML = "<li>No hay solicitudes de unidades pendientes.</li>";
            return;
          }
          list.forEach(s => {
            const li = document.createElement("li");
            li.innerHTML = `
              ${s.nombre} solicitó ${s.direccion}
              <button onclick="doPost('aprobar_solicitud_unidad',{solicitud_id:${s.solicitud_id}}, loadAllAdminViews)">Aprobar</button>
              <button onclick="doPost('rechazar_solicitud_unidad',{solicitud_id:${s.solicitud_id}}, loadAllAdminViews)">Rechazar</button>
            `;
            ul.appendChild(li);
          });
        });
    }

    function loadAllAdminViews() {
      loadRegs();
      loadPays();
      loadSolicitudesUnidades();
    }

    document.getElementById("btnResetAll").addEventListener("click", () => {
    if (!confirm("¿Seguro que querés reiniciar horas y plata de todos?")) return;
    doPost("reset_all", {}, () => {
      loadAllAdminViews();
      alert("Se reinició horas y plata de todos los usuarios.");
    });
    });

    // Inicializar
    loadAllAdminViews();
  </script>
</body>
</html>
